<!DOCTYPE html>
<html lang="en">
  <body>
    <style>
      @keyframes in {
        from {
          transform: translateY(-5rem);
          scale: .2;
        }
        to {
          opacity: 1;
          transform: translateY(0);
          scale: 1;
        }
      }
      main {
        max-width: fit-content;
        margin: 2vh auto 0;
        font-size: clamp(1rem, 0.478rem + 2.609vw, 2.5rem);
        color: #e6e6e6bf;
      }
    </style>
    <main></main>
    <script>
      const m = document.querySelector('main');
      const r = (x, y) => Math.floor(Math.random() * (y - x) + x);
      // TODO: vowel strings together in a single string to avoid repetition
      const vs = 'iɨʉuʏɤɘəɵoɛɜaäɑɒœɶæɐøɞʌɔɪeɯyʊ'.split('');

      // I've arranged the vowels in 4 sets of alternating rhyming pairs (but only use 3)
      // So to select rhyming pairs for quatrains:
      // index of vowels = l + (z * 4)
      const quatrainVs = 'iʉɨuʏɘɤəɵɛoɜaɑäɒ';
      const coupletVs = 'œɶiɨʉuʏɤɘəɵoɛɜaäɑɒ';

      // console.log('quatrainVs:', quatrainVs);
      // console.log('coupletVs:', coupletVs);

      // vowels in rhyme scheme ABABCDCDEFEFGG (except with more quatrains):
      // iʉɨu ʏɘɤə ɵɛoɜ aɑäɒ œɶ

      const hues = [100, 200, 300];
      const c = (h, s, l, a) => `hsla(${h} ${s}% ${l}% / ${a})`;

      const sylT = 30; // 180,
      const pD = 100;  // 600,
      const liT = pD * 5;

      const rhyme = (i, l) => i === 9 && {
        // col: l % 2 ? c(100,50,50,.8) : c(300,50,50,.8),
        bdr: l % 2 ? `${r(30,50)}% ${r(10,15)}%` : `${r(10,20)}% ${r(40,50)}%`,
        // vwl: l % 2 ? vs[r(9, 19)] : vs[r(0, 8)]
      };

      const rhymeVC = (i,l,z) => {
        if (i==9 && z<3) {
          // console.log('l:', l, 'in z:', z);
          console.log('hue1:', 60 + (z * 90), 'hue2:', 120 + (z * 90));
          // console.log('vowel', quatrainVs[l + (z * 4)]);
          return {
            vwl: quatrainVs[l + (z * 4)],
            col: l % 2 ? c((60+(z*90)),50,50,1) : c((120+z*90),50,50,1),
          }
        }
        else if (i==9 && z==3) {
          // console.log('l:', l, 'couplet vowel', coupletVs[l]);
          return {
            vwl: coupletVs[l],
            col: c(0, 50, 50, .9),
          }
        }
      }

      const vowl = (i, l, z) => rhymeVC(i,l,z)?.vwl || vs[r(0, 29)];
      const color = (i, l, z) => rhymeVC(i,l,z)?.col || c(r(0, 360),r(20, 100),r(40, 60),r(6,8)/10);
      const bordr = (i, l) => rhyme(i, l)?.bdr || `${r(0,50)}% ${r(0,50)}% ${r(0,50)}% ${r(0,50)}%`;

      const mkLi = (l,z) => {
        // console.log('li in stz:', z);
        let li = '';
        li += `<div>`;
        for (i=0; i<10; i++) {
            pI = Math.floor(i/2),
            dly = (pI * pD) + (i%2===0 ? 0 : sylT) + (liT * l),
            syl = `<div style="background-color: ${color(i, l, z)};
                  border-radius: ${bordr(i, l)};
                  padding: 0 .25em;
                  margin:2px;
                  display: inline-block;
                  opacity:0;
                  animation: .5s ${dly}ms ease-in-out forwards in;">
                  ${vowl(i, l, z)}
                  </div>`;
          li += syl;
        }
        return li += `</div>`;
      }
      // z param is for stanza number and works for the 3 quatrains (0-2) & the couplet (3)
      const mkStz = (n, z, cup = false) => {
        console.log('stz:', z);
        let stz = '';
        stz += '<div>';
        for (l=0; l<n; l++) {
          stz += mkLi(l,z);
        }
        // console.log(cup);
        return stz += `</div>`;
      }

      const mkSnt = () => {
        let snt = '';
        for (let z=0; z<3; z++) {
          snt += mkStz(4, z);
        }
        snt += `<div id="cup"></div>`;
        setTimeout(() => {
          // couplet is stanza 3 (index)
          document.querySelector('#cup').innerHTML = mkStz(2, 3, true);
        }, liT*4 + 900);
        return snt;
      }

      m.innerHTML = mkSnt();

    </script>
  </body>
</html>
